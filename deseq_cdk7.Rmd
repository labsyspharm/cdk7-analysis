---
title: "CDK7 DESeq2"
author: "Clemens Hug"
date: "2023-07-28"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(data.table)
library(qs)
library(DESeq2)
library(synExtra)
library(IHW)

synapser::synLogin()
syn <- synDownloader("~/data", .cache = TRUE)

syn_analysis <- "syn51221227"
```

Reading count and metadata tables generated in `qc.Rmd`.

```{r}
ensembl_gtf_file <- "Homo_sapiens.GRCh38.109.gtf.gz"
if (!file.exists(ensembl_gtf_file)) {
  download.file(
    "ftp://ftp.ensembl.org/pub/release-109/gtf/homo_sapiens/Homo_sapiens.GRCh38.109.gtf.gz",
    ensembl_gtf_file, method = "curl"
  )
}

ensembl_gtf <- rtracklayer::readGFF(
  ensembl_gtf_file
) %>%
  distinct(
    ensembl_gene_id = gene_id,
    hgnc_symbol = gene_name,
    gene_biotype
  ) %>%
  drop_na(ensembl_gene_id) %>%
  mutate(
    gene_name = coalesce(hgnc_symbol, ensembl_gene_id)
  )

barcode_well_map <- syn("syn12979100") %>%
  readxl::read_xlsx(sheet = "barcodes_trugrade_384_set1")
  # rename(Barcode = barcode, Well = well, Plate_ID = plate_id)



prepare_barcode_counts <- function(barcode_count_file, barcode_map) {
  read_tsv(barcode_count_file, col_names = c("barcode", "count")) %>%
    mutate(
      barcode = str_replace(barcode, "^.*([ATCG]{6})$", "\\1")
    ) %>%
    left_join(
      barcode_well_map, by = "barcode"
    )
}

prepare_col_meta <- function(colmeta_file, barcode_map) {
  read_csv(colmeta_file, col_names = "barcode") %>%
    mutate(
      barcode = if (all(str_detect(barcode, fixed(":")))) str_split(barcode, fixed(":"), simplify = TRUE)[, 2] else barcode,
      col_idx = 1:n()
    ) %>%
    left_join(
      barcode_map %>%
        select(barcode, well),
      by = "barcode"
    )
}

prepare_row_meta <- function(rowmeta_file) {
  read_csv(rowmeta_file, col_names = "ensembl_gene_id") %>%
    mutate(row_idx = 1:n())
}

prepare_mtx_sparse <- function(mtx_file) {
  read_delim(
    mtx_file,
    delim = " ",
    skip = 3,
    col_names = c("row_idx", "col_idx", "count"),
    col_types = "iii"
  )
}

prepare_counts <- function(mtx, col_meta, row_meta, gene_mapping) {
  # browser()
  mtx %>%
    left_join(col_meta, by = "col_idx") %>%
    left_join(row_meta, by = "row_idx") %>%
    select(well, ensembl_gene_id, count) %>%
    left_join(
      gene_mapping, by = "ensembl_gene_id"
    )
}


```

```{r}
raw_synapse_old <- synGlob(
  "syn52226362", "*", "*mtx*"
)

meta_old <- syn("syn21544269") %>%
  read_csv() %>%
  transmute(
    experiment = "cdk_467_2019_08",
    plate_id = plate,
    batch_id = plate,
    well,
    cell_line,
    agent  = recode(agent, "DMSO" = "control"),
    agent_conc = concentration,
    time = timepoint
  ) %>%
  drop_na(cell_line)

meta_new <- syn("syn51181405") %>%
  read_csv() %>%
  filter(
    source_96 %in% c("Plate 2", "Plate 3"),
    agent != "7 Fluids"
  ) %>%
  transmute(
    experiment = "cdk_467_2023_02",
    plate_id = 1,
    batch_id = str_match(source_96, "Plate ([0-9]+)")[, 2] %>% as.numeric(),
    well = str_replace(well_384, "^([A-Z])([0-9])$", "\\10\\2"),
    cell_line,
    agent  = recode(agent, "DMSO" = "control"),
    agent_conc = concentration,
    time = timepoint
  ) %>%
  mutate(
    agent = if_else(str_detect(cell_line, "YKLr"), "YKLr", agent),
    agent_conc = if_else(str_detect(cell_line, "YKLr"), 1, agent_conc),
    cell_line = str_replace(cell_line, "-YKLr", "")
  )

meta_all <- bind_rows(meta_old, meta_new) %>%
  mutate(
    sample_id = paste(experiment, plate_id, well, sep = "_"),
    batch = paste(experiment, batch_id)
  )
```


```{r}
meta_all %>%
  dplyr::count(agent) %>%
  View()

meta_all %>%
  dplyr::count(cell_line, agent) %>%
  View()
```



```{r}
raw_synapse_all <- raw_synapse_old %>%
  enframe("file_name", "synapse_id") %>%
  filter(!str_detect(file_name, "dupes")) %>%
  mutate(
    file_type = case_when(
      str_ends(file_name, ".mtx") ~ "mtx",
      str_ends(file_name, "colnames") ~ "colnames",
      str_ends(file_name, "rownames") ~ "rownames"
    ),
    plate_id = as.double(str_match(file_name, "S([0-9]+)")[, 2]),
    experiment = "cdk_467_2019_08"
  ) %>%
  bind_rows(
    tribble(
      ~synapse_id, ~file_type,
      "syn51181399", "mtx",
      "syn51181400", "colnames",
      "syn51181404", "rownames"
    ) %>%
      mutate(
        plate_id = 1,
        experiment = "cdk_467_2023_02"
      )
  ) %>%
  mutate(
    file_path = map_chr(synapse_id, syn)
  )

files_all <- raw_synapse_all %>%
  pivot_wider(values_from = c(file_name, synapse_id, file_path), names_from = file_type)

counts_raw <- files_all %>%
  mutate(
    col_meta = map(file_path_colnames, ~prepare_col_meta(.x, barcode_map = barcode_well_map)),
    row_meta = map(file_path_rownames, ~prepare_row_meta(.x)),
    mtx = map(file_path_mtx, ~prepare_mtx_sparse(.x)),
    counts = pmap(
      list(mtx, col_meta, row_meta),
      prepare_counts,
      gene_mapping = ensembl_gtf
    )
  )

```

```{r}
counts_all <- counts_raw %>%
  select(experiment, plate_id, counts) %>%
  unnest(counts)

well_counts <- counts_all %>%
  group_by(experiment, plate_id, well) %>%
  summarize(
    total_count = sum(count),
    .groups = "drop"
  ) %>%
  inner_join(
    meta_all,
    by = c("experiment", "plate_id", "well")
  )

samples_to_keep <- well_counts %>%
  filter(total_count > 80000)

genes_to_keep <- counts_all %>%
  group_by(
    ensembl_gene_id
  ) %>%
  summarize(
    keep = sum(count > 5) > 5,
    .groups = "drop"
  )
```

```{r}
meta_kept <- meta_all %>%
  semi_join(
    samples_to_keep,
    by = c("experiment", "plate_id", "well")
  )

conditions_kept <- meta_kept %>%
  distinct(experiment, plate_id, batch_id,cell_line, agent, time) %>%
  mutate(
    condition_id = paste(experiment, plate_id, batch_id, cell_line, agent, time, sep = "_")
  )

counts_kept <- counts_all %>%
  semi_join(
    samples_to_keep,
    by = c("experiment", "plate_id", "well")
  ) %>%
  semi_join(
    genes_to_keep %>%
      filter(keep),
    by = "ensembl_gene_id"
  ) %>%
  inner_join(
    meta_all %>%
      select(experiment, plate_id, well, sample_id),
    by = c("experiment", "plate_id", "well")
  )
```

Visualize experimental design
```{r}
meta_kept %>%
  mutate(
    batch = paste(experiment, batch_id)
  ) %>%
  dplyr::count(
    experiment, batch, cell_line, agent, time, agent_conc
  ) %>%
  ggplot(
    aes(
      agent,
      fct_inseq(as.character(agent_conc)),
      fill = batch
    )
  ) +
  geom_tile() +
  facet_grid(cell_line ~ time)

```


```{r}
counts_mat <- counts_kept %>%
  select(sample_id, ensembl_gene_id, count) %>%
  pivot_wider(names_from = sample_id, values_from = count, values_fill = 0L) %>%
  column_to_rownames("ensembl_gene_id") %>%
  as.matrix()

size_factors <- DESeq2::estimateSizeFactorsForMatrix(counts_mat)

counts_mat_corrected <- t(t(counts_mat) / size_factors)

counts_corrected <- counts_mat_corrected %>%
  as_tibble(rownames = "ensembl_gene_id") %>%
  pivot_longer(
    cols = -ensembl_gene_id,
    names_to = "sample_id",
    values_to = "count"
  )
```


```{r}
meta_deseq <- meta_kept %>%
  mutate(
    across(time, ~as.factor(as.character(.x))),
    across(batch_id, ~as.factor(as.character(.x)))
  ) %>%
  arrange(match(sample_id, colnames(counts_mat))) %>%
  column_to_rownames("sample_id")
```


Variance stabilizing transformation

```{r}
dds <- DESeqDataSetFromMatrix(
  counts_mat,
  colData = meta_deseq,
  design = ~experiment + agent + cell_line + time
)

vsd <- varianceStabilizingTransformation(dds)

vsd_mat <- assay(vsd)
```

```{r}
pca_vsd <- vsd_mat %>%
  t() %>%
  prcomp()

pca_vsd_df <- pca_vsd$x[, 1:10] %>%
  as_tibble(rownames = "sample_id") %>%
  inner_join(
    meta_deseq %>%
      rownames_to_column("sample_id"),
    by = "sample_id"
  )

p <- ggplot(
  pca_vsd_df,
  aes(x = PC1, y = PC2, color = cell_line, shape = experiment)
) +
  geom_point()
```

Overlapping conditions between batches

```{r}
meta_batch_correction <- meta_kept %>%
  semi_join(
    meta_kept %>%
      distinct(experiment, cell_line, agent) %>%
      filter(agent == "control") %>%
      group_by(cell_line, agent) %>%
      filter(n() > 1)
  )
```

Remove batch effects using ComBat

```{r}
library(sva)

source("combat_with_reference.R")
combat_res <- combat_with_reference(
  counts_mat[, meta_batch_correction$sample_id],
  batch = with(
    meta_batch_correction,
    paste(experiment, sep = "_")
  ),
  covar_mod = model.matrix(
    ~cell_line,
    data = meta_batch_correction
  ),
  covar_mod_all = model.matrix(
    ~cell_line + agent,
    data = meta_deseq
  ),
  batch_all = with(
    meta_deseq,
    paste(experiment, sep = "_")
  ),
  counts_all = counts_mat
)
```

```{r}
dds_bc <- DESeqDataSetFromMatrix(
  combat_res,
  colData = meta_deseq,
  design = ~experiment + agent + cell_line + time
)

vsd_bc <- varianceStabilizingTransformation(dds_bc)

vsd_mat_bc <- assay(vsd_bc)
```

```{r}
pca_vsd_bc <- vsd_mat_bc %>%
  t() %>%
  prcomp()

pca_vsd_bc_df <- pca_vsd_bc$x[, 1:10] %>%
  as_tibble(rownames = "sample_id") %>%
  inner_join(
    meta_deseq %>%
      rownames_to_column("sample_id"),
    by = "sample_id"
  )

p <- ggplot(
  pca_vsd_bc_df,
  aes(x = PC1, y = PC2, color = cell_line, shape = experiment)
) +
  geom_point()
```

Much improved batch effect

```{r}
extract_deseq_result <- function(de, contrast, name, res_args = list(), shrink_args = list()) {
  if (missing(contrast)) {
    res <- rlang::exec(results, de, name = name, !!!res_args)
  } else {
    res <- rlang::exec(results, de, contrast = contrast, !!!res_args)
  }
  shrunken <- rlang::exec(lfcShrink, de, res = res, type = "ashr", !!!shrink_args)
  shrunken %>%
    as_tibble(rownames = "gene_id") %>%
    left_join(
      res %>%
        as_tibble(rownames = "gene_id") %>%
        select(gene_id, log2FoldChange, lfcSE),
      by = "gene_id", suffix = c("", "_MLE")
    )
}
```

No batch correction necessary here. Only 4 conditions where that would even
be possible. Otherwise each condition is unique to a batch.

```{r}
deseq_input <- meta_kept %>%
  filter(agent != "control") %>%
  group_nest(experiment, plate_id, batch_id, agent, cell_line, time, .key = "treated") %>%
  left_join(
    meta_kept %>%
      filter(agent == "control") %>%
      group_nest(experiment, plate_id, batch_id, cell_line, time, .key = "control"),
    by = c("experiment", "plate_id", "batch_id", "cell_line", "time")
  ) %>%
  # mutate(
  #   control = map2(
  #     control, treated,
  #     ~filter(.x, batch %in% .y$batch)
  #   )
  # ) %>%
  filter(
    map_int(treated, nrow) > 1,
    map_int(control, nrow) > 1
  ) %>%
  mutate(
    meta_deseq = map2(
      treated, control,
      ~bind_rows(.x, .y) %>%
        mutate(
          log_agent_conc = log10(agent_conc + 1)
        )
    )
    # batch_correct = map_lgl(meta_deseq, \(x) n_distinct(x$batch) > 1)
  )

deseq_fit <- deseq_input %>%
  mutate(
    deseq = map(
      meta_deseq,
      \(m) {
        DESeqDataSetFromMatrix(
          counts_mat[, m$sample_id],
          colData = column_to_rownames(m, "sample_id"),
          design = ~log_agent_conc
          # design = if (bc) {~log_agent_conc + batch} else {~log_agent_conc}
        )
      }
    )
  )

qsave(
  deseq_fit,
  file.path("deseq", "cdk7_deseq_res_raw2.qs")
)
# deseq_fit <- qread("deseq/cdk7_deseq_res_raw2.qs")

deseq_res <- deseq_fit %>%
  rowwise() %>%
  mutate(
    res = {
      extract_deseq_result(
        deseq, name = "log_agent_conc"
      ) %>%
        dplyr::rename(
          ensembl_gene_id = gene_id
        ) %>%
        left_join(
          ensembl_gtf %>%
            select(ensembl_gene_id, hgnc_symbol),
          by = "ensembl_gene_id"
        ) %>%
        list()
    }
  ) %>%
  ungroup()

qsave(
  deseq_res %>%
    select(-deseq),
  file.path("deseq", "cdk7_deseq_res2.qs")
)
# deseq_res <- qread("deseq/cdk7_deseq_res2.qs")
```

```{r}
deseq_fit_lrt <- deseq_input %>%
  rowwise() %>%
  mutate(
    meta_deseq = meta_deseq %>%
      mutate(
        agent_conc_fct = fct_inseq(as.character(agent_conc))
      ) %>%
      list(),
    deseq = DESeqDataSetFromMatrix(
      counts_mat[, meta_deseq$sample_id],
      colData = column_to_rownames(meta_deseq, "sample_id"),
      design = ~agent_conc_fct
    ) %>%
      DESeq(
        test = "LRT",
        reduced = ~1
      ) %>%
      list()
  ) %>%
  ungroup()

qsave(
  deseq_fit_lrt,
  file.path("deseq", "cdk7_deseq_res_lrt_raw2.qs")
)
# deseq_fit_lrt <- qread("deseq/cdk7_deseq_res_lrt_raw2.qs")

deseq_res_lrt <- deseq_fit_lrt %>%
  rowwise() %>%
  mutate(
    res = results(
      deseq, tidy = TRUE
    ) %>%
      dplyr::rename(ensembl_gene_id = row) %>%
      left_join(
        ensembl_gtf %>%
          select(ensembl_gene_id, hgnc_symbol),
        by = "ensembl_gene_id"
      ) %>%
      as_tibble() %>%
      list()
  ) %>%
  ungroup()
```

```{r}
deseq_res_lrt_long <- deseq_res_lrt %>%
  select(experiment, plate_id, batch_id, agent, cell_line, time, res) %>%
  unnest(res)

deseq_res_long <- deseq_res %>%
  select(experiment, plate_id, batch_id, agent, cell_line, time, res) %>%
  unnest(res)

write_csv(
  deseq_res_long,
  file.path("deseq", "cdk7_deseq_res_long.csv")
)
# deseq_res_long <- read_csv(
#   file.path("deseq", "cdk7_deseq_res_long.csv")
# )

write_csv(
  deseq_res_lrt_long,
  file.path("deseq", "cdk7_deseq_res_lrt_long.csv")
)
# deseq_res_lrt_long <- read_csv(
#   file.path("deseq", "cdk7_deseq_res_lrt_long.csv")
# )
```


Combined

```{r}
deseq_res_combined <- deseq_res_long %>%
  powerjoin::power_inner_join(
    deseq_res_lrt_long %>%
    select(
      experiment, plate_id, batch_id,
      agent, cell_line, time,
      ensembl_gene_id,
      pvalue_lrt = pvalue,
      padj_lrt = padj
    ),
    by = c(
      "experiment", "plate_id", "batch_id",
      "agent", "cell_line", "time",
      "ensembl_gene_id"
    ),
    check = powerjoin::check_specs(
      duplicate_keys_left = "warn",
      duplicate_keys_right = "warn",
      unmatched_keys_left = "warn",
      unmatched_keys_right = "warn"
    )
  )

write_csv(
  deseq_res_combined,
  file.path("deseq", "cdk7_deseq_res_combined_long.csv")
)
```

Upload DGE results to Synapse

```{r}
syn_analysis <- synMkdir("syn52226362", "analysis")

synStoreMany(
  c(
    "deseq/cdk7_deseq_res_long.csv",
    "deseq/cdk7_deseq_res_lrt_long.csv",
    file.path("deseq", "cdk7_deseq_res_combined_long.csv")
  ),
  syn_analysis,
  forceVersion = FALSE
)

```


Checking goodness of fit of the log-linear model using advice
from https://support.bioconductor.org/p/117448

```{r}

x <- deseq_fit$deseq[[1]]
y <- mcols(x)$deviance - 2*rowSums(dnbinom(counts(x), mu=counts(x), size=1/dispersions(x), log=TRUE))

counts_corrected %>%
  filter(
    ensembl_gene_id %in% names(head(sort(y, decreasing = TRUE))),
    sample_id %in% colnames(x)
  ) %>%
  inner_join(
    deseq_fit$meta_deseq[[1]] %>%
      rownames_to_column("sample_id")
  ) %>%
  ggplot(
    aes(log_agent_conc, count, color = agent)
  ) +
    geom_point() +
    facet_wrap(~ensembl_gene_id, scales = "free_y")
```

Apeglm leads to some weird artifacts where the log2FoldChange is not shrunk but
expanded multifold. Using ashr instead.

```{r}
p <- deseq_res_long %>%
  filter(
    experiment == "cdk_467_2019_08",
    agent == "YKL-5-124"
  ) %>%
  ggplot(
    aes(log2FoldChange, -log10(padj))
  ) +
    ggrastr::rasterize(
      geom_point(shape = 16, alpha = 0.3),
      dev = "ragg", dpi = 200
    ) +
    facet_wrap(~cell_line, scale = "free")

ggsave(
  file.path("plots_cdk7", "ykl_lfc_padj.pdf"),
  p,
  width = 10,
  height = 8
)
```


```{r}
deseq_res_long %>%
  group_by(experiment, plate_id, agent, cell_line, time) %>%
  summarize(
    n_sig = sum(padj < 0.05, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes("0", n_sig, color = cell_line)) +
    ggbeeswarm::geom_quasirandom() +
    facet_wrap(~experiment + plate_id)

deseq_res_lrt_long %>%
  group_by(experiment, plate_id, agent, cell_line, time) %>%
  summarize(
    n_sig = sum(padj < 0.05, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  ggplot(aes("0", n_sig, color = cell_line)) +
    ggbeeswarm::geom_quasirandom() +
    facet_wrap(~experiment + plate_id)

deseq_n_res_lin_vs_lrt <- deseq_res_long %>%
  group_by(experiment, plate_id, agent, cell_line, time) %>%
  summarize(
    n_sig_lin = sum(padj < 0.05, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  left_join(
    deseq_res_lrt_long %>%
      group_by(experiment, plate_id, agent, cell_line, time) %>%
      summarize(
        n_sig_lrt = sum(padj < 0.05, na.rm = TRUE),
        .groups = "drop"
      )
  )

p <- deseq_n_res_lin_vs_lrt %>%
  ggplot(
    aes(n_sig_lin, n_sig_lrt, color = cell_line)
  ) +
    geom_point() +
    facet_wrap(~experiment + plate_id) +
    coord_equal() +
    geom_abline(slope = 1, intercept = 0) +
    scale_x_continuous(
      trans = scales::pseudo_log_trans(base = 10),
      breaks = function(...) {
        l <- list(...)
        l[[1]][1] <- max(l[[1]][1], 1)
        x <- rlang::exec(scales::breaks_log(), !!!l)
        c(0, x)
      }
    ) +
    scale_y_continuous(
      trans = scales::pseudo_log_trans(base = 10),
      breaks = function(...) {
        l <- list(...)
        l[[1]][1] <- max(l[[1]][1], 1)
        x <- rlang::exec(scales::breaks_log(), !!!l)
        c(0, x)
      }
    )
ggsave(
  file.path("plots_cdk7", "n_sig_lin_vs_lrt.pdf"),
  p,
  width = 10,
  height = 8
)

deseq_n_res_lin_vs_lrt %>% filter(n_sig_lrt > 10*n_sig_lin)

deseq_n_res_lin_vs_lrt %>% filter(n_sig_lrt > 10*n_sig_lin) %>%
  dplyr::slice(2) %>%
  inner_join(
    deseq_res_lrt %>%
      select(experiment, plate_id, agent, cell_line, time, res, meta_deseq)
  ) %>%
  mutate(
    across(res, map, \(x) filter(x, padj < 0.05)),
    across(meta_deseq, map, \(x) select(x, sample_id, log_agent_conc))
  ) %>%
  unnest(res) %>%
  unnest(meta_deseq) %>%
  inner_join(
    counts_corrected
  ) %>%
  ggplot(
    aes(log_agent_conc, count, color = agent)
  ) +
    geom_point() +
    facet_wrap(~ensembl_gene_id, scales = "free_y")

counts_corrected %>%
  inner_join(
    deseq_res_lrt_long %>%
      inner_join(
        deseq_n_res_lin_vs_lrt %>% filter(n_sig_lrt > 10*n_sig_lin)
      ) %>%
      filter(padj < 0.05) %>%
      inner_join(
        meta_kept
      )
  ) %>%
  ggplot(
    aes(agent_conc, count, color = agent)
  ) +
    geom_point() +
    facet_wrap(~ensembl_gene_id, scales = "free_y")
```


```{r}


deseq_res_lfc_shrunk_wide <- deseq_res_long %>%
  inner_join(
    conditions_kept
  ) %>%
  select(condition_id, ensembl_gene_id, log2FoldChange) %>%
  mutate(across(log2FoldChange, ~replace_na(.x, 0))) %>%
  pivot_wider(names_from = condition_id, values_from = log2FoldChange, values_fill = 0)

deseq_res_lfc_shrunk_wide_mat <- deseq_res_lfc_shrunk_wide %>%
  column_to_rownames("ensembl_gene_id") %>%
  as.matrix()
```


```{r}
pca_lfc_shrunk <- deseq_res_lfc_shrunk_wide_mat[
  deseq_res_long %>%
    group_by(ensembl_gene_id) %>%
    filter(any(padj < 0.05)) %>%
    ungroup() %>%
    pull(ensembl_gene_id) %>%
    unique(),
] %>%
  t() %>%
  prcomp()

pca_lfc_shrunk_df <- pca_lfc_shrunk$x[, 1:10] %>%
  as_tibble(rownames = "condition_id") %>%
  inner_join(
    conditions_kept,
    by = "condition_id"
  )

p <- ggplot(
  pca_lfc_shrunk_df,
  aes(x = PC1, y = PC2, color = cell_line, shape = experiment)
) +
  geom_point()
```

## Baseline

```{r read_gr_metrics}
gr_raw <- syn("syn52242760") %>%
  read_csv() %>%
  mutate(neglog_GR50 = -log10(GR50))

baseline_meta <- meta_kept %>%
  filter(
    agent == "control",
    experiment == "cdk_467_2019_08",
    cell_line %in% gr_raw$cell_line
  )

baseline_cell_overlap <- unique(baseline_meta$cell_line)
```


```{r}
de_baseline <- DESeqDataSetFromMatrix(
  counts_mat[, baseline_meta$sample_id],
  colData = column_to_rownames(baseline_meta, "sample_id"),
  design = ~0 + cell_line
) %>%
  DESeq()

qsave(
  de_baseline,
  file.path("deseq", "cdk7_deseq_baseline.qs")
)

de_baseline_res <- resultsNames(de_baseline) %>%
  set_names() %>%
  map(
    ~{
      n <- length(resultsNames(de_baseline))
      contrast_vec <- rep(
        -1/n,
        n
      ) %>%
        set_names(resultsNames(de_baseline))
      contrast_vec[match(.x, names(contrast_vec))] <- (n - 1) / n
      r <- results(de_baseline, contrast = contrast_vec)
      left_join(
        as.data.frame(r) %>%
          as_tibble(rownames = "ensembl_gene_id"),
        lfcShrink(
          de_baseline, contrast = contrast_vec, res = r, type = "ashr"
        ) %>%
          as_tibble(rownames = "ensembl_gene_id") %>%
          select(ensembl_gene_id, log2FoldChange),
        by = "ensembl_gene_id",
        suffix = c("_MLE", "")
      ) %>%
        left_join(
          ensembl_gtf %>%
            select(ensembl_gene_id, hgnc_symbol),
          by = "ensembl_gene_id"
        )
    }
  ) %>%
  bind_rows(.id = "cell_line") %>%
  mutate(across(cell_line, \(x) str_replace(x, "cell_line", "")))

write_csv(
  de_baseline_res,
  file.path("deseq", "cdk7_deseq_baseline_res.csv")
)
# de_baseline_res <- read_csv(
#   file.path("deseq", "cdk7_deseq_baseline_res.csv")
# )
```

```{r}
synStoreMany(
  c(
    file.path("deseq", "cdk7_deseq_baseline_res.csv")
  ),
  syn_analysis,
  forceVersion = FALSE
)

```

## Deep RNA-seq baseline

```{r}
deep_counts <- syn("syn60529544") %>%
  read_csv()

deep_meta <- syn("syn60529546") %>%
  readxl::read_excel() %>%
  mutate(
    sample_id = paste0("S", Sample)
  ) %>%
  dplyr::rename(cell_line = `Cell line`)

# Used Ensembl gene annotation version 92
ensembl_gtf_file_old <- "Homo_sapiens.GRCh38.92.gtf.gz"
if (!file.exists(ensembl_gtf_file_old)) {
  download.file(
    "ftp://ftp.ensembl.org/pub/release-92/gtf/homo_sapiens/Homo_sapiens.GRCh38.92.gtf.gz",
    ensembl_gtf_file_old, method = "curl"
  )
}

ensembl_gtf_old <- rtracklayer::readGFF(
  ensembl_gtf_file_old
) %>%
  distinct(
    ensembl_gene_id = gene_id,
    hgnc_symbol = gene_name,
    gene_biotype
  ) %>%
  drop_na(ensembl_gene_id) %>%
  mutate(
    gene_name = coalesce(hgnc_symbol, ensembl_gene_id)
  )

```

Can't do DESeq2 because no replicates. Use edgeR with estimated dispersion of .4
instead. .4 recommended in manual for human samples.

```{r}
deep_counts_mat <- deep_counts %>%
  semi_join(
    ensembl_gtf_old %>%
      filter(gene_biotype == "protein_coding"),
    by = c("gene" = "ensembl_gene_id")
  ) %>%
  mutate(
    across(
      -gene,
      as.integer
    )
  ) %>%
  column_to_rownames("gene") %>%
  as.matrix()

deep_size_factors <- estimateSizeFactorsForMatrix(deep_counts_mat)
deep_counts_mat_corrected <- t(t(deep_counts_mat) / deep_size_factors)


deep_counts_corrected <- deep_counts_mat_corrected %>%
  as_tibble(rownames = "ensembl_gene_id") %>%
  pivot_longer(
    cols = -ensembl_gene_id,
    names_to = "sample_id",
    values_to = "count"
  )

deep_counts_varstab <- varianceStabilizingTransformation(deep_counts_mat) %>%
  as_tibble(rownames = "ensembl_gene_id") %>%
  pivot_longer(
    cols = -ensembl_gene_id,
    names_to = "sample_id",
    values_to = "count"
  )

deep_all_counts_long <- bind_rows(
  raw = deep_counts %>%
    dplyr::rename(ensembl_gene_id = gene) %>%
    semi_join(
      ensembl_gtf_old %>%
        filter(gene_biotype == "protein_coding"),
      by = c("ensembl_gene_id")
    ) %>%
    pivot_longer(
      cols = -ensembl_gene_id,
      names_to = "sample_id",
      values_to = "count"
    ),
  normalized = deep_counts_corrected,
  varstab = deep_counts_varstab,
  .id = "type"
) %>%
  left_join(
    ensembl_gtf_old %>%
      select(ensembl_gene_id, hgnc_symbol, gene_name),
    by = "ensembl_gene_id"
  ) %>%
  left_join(
    deep_meta %>%
      select(sample_id, cell_line),
    by = "sample_id"
  )

write_csv(
  deep_all_counts_long,
  file.path("deseq", "deep_baseline_counts_long.csv.gz")
)

# deep_deseq <- DESeqDataSetFromMatrix(
#   deep_counts_mat[, deep_meta$sample_id],
#   deep_meta %>%
#     column_to_rownames("sample_id"),
#   design = ~0 + cell_line
# ) %>%
#   DESeq()

library(edgeR)
deep_dge_list <- DGEList(
  counts = deep_counts_mat[, deep_meta$sample_id],
  # genes = tibble(ensembl_gene_id = rownames(deep_counts_mat)),
  samples = deep_meta %>%
    select(cell_line)
) %>%
  normLibSizes()

deep_design_sum <- contr.sum(
  factor(deep_meta$cell_line)
) %>%
  magrittr::set_rownames(deep_meta$sample_id)

deep_glm_sum <- glmFit(
  deep_dge_list, deep_design_sum,
  dispersion = .4
)

test_res <- glmLRT(
  deep_glm_sum,
  coef = 6,
) %>%
  topTags(n = Inf) %>%
  as.data.frame() %>%
  as_tibble()

test_res %>%
  mutate(up_down = if_else(logFC > 0, "up", "down")) %>%
  filter(FDR < 0.05) %>%
  dplyr::count(up_down)


library(contrast)

contrast(

)

deep_design <- model.matrix(~0 + cell_line, data = deep_meta) %>%
  magrittr::set_rownames(deep_meta$sample_id)

deep_glm <- glmFit(
  deep_dge_list, deep_design,
  dispersion = .4
)

test_res <- glmLRT(
  deep_glm,
  contrast = {
    n <- ncol(deep_design)
    print(n)
    contrast_vec <- rep(
      1 / (n - 1),
      n
    )
    contrast_vec[2] <- -1
    # contrast_vec <- rep(0, n)
    # # contrast_vec[3] <- -1
    # contrast_vec[c(1, 2)] <- -(1 - 1/n)
    # contrast_vec[4] <- 1
    contrast_vec
  }
) %>%
  topTags(n = Inf) %>%
  as.data.frame() %>%
  as_tibble()

test_res %>%
  mutate(up_down = if_else(logFC > 0, "up", "down")) %>%
  filter(FDR < 0.05) %>%
  dplyr::count(up_down)

deep_results <- deep_meta %>%
  distinct(cell_line) %>%
  mutate(
    res = map(
      cell_line,
      \(x) {
        n <- ncol(deep_design)
        contrast_vec <- rep(
          -1 / n,
          n
        )
        contrast_vec[match(paste0("cell_line", x), colnames(deep_design))] <- 1
        glmLRT(
          deep_glm,
          contrast = contrast_vec
        ) %>%
          topTags(n = Inf) %>%
          as.data.frame() %>%
          as_tibble()
      }
    )
  )

deep_results_long <- deep_results %>%
  select(cell_line, res) %>%
  unnest(res)

write_csv(
  deep_results_long,
  file.path("deseq", "deep_baseline_edger_res.csv.gz")
)
```



```{r}
p <- deep_results_long %>%
  ggplot(
    aes(logFC, -log10(FDR))
  ) +
    ggrastr::rasterize(geom_point(), dev = "ragg", dpi = 200) +
    facet_wrap(~cell_line)

```


```{r}
synStoreMany(
  c(
    file.path("deseq", "deep_baseline_counts_long.csv.gz")
  ),
  parentId = "syn59470136",
  forceVersion = FALSE
)

```

